<!-- getBoundingClientRect + Scroll with Throttle + HTML DataSet API -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图片懒加载</title>
  <style>
    * {
      margin: 0px;
      padding: 0px;
    }

    img {
      /* display: block; */
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <img src="https://cdn.pixabay.com/photo/2021/08/24/15/38/sand-6570980_960_720.jpg" alt="1" />
  <img src="https://cdn.pixabay.com/photo/2013/02/21/19/06/drink-84533_960_720.jpg" alt="2" />
  <img data-src="https://cdn.pixabay.com/photo/2013/07/18/20/26/sea-164989_960_720.jpg" alt="3" />
  <img data-src="https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885_960_720.jpg" alt="4" />
  <img data-src="https://cdn.pixabay.com/photo/2017/03/26/21/54/yoga-2176668_960_720.jpg" alt="5" />
  <img data-src="https://cdn.pixabay.com/photo/2021/08/24/15/38/sand-6570980_960_720.jpg" alt="6" />
  <img data-src="https://cdn.pixabay.com/photo/2013/02/21/19/06/drink-84533_960_720.jpg" alt="7" />
  <script>
    const imgs = document.querySelectorAll('img[data-src]')
    const lazyLoad = () => {
      for (let image of imgs) {
        if (
          image.getBoundingClientRect().top <= document.documentElement.clientHeight
        ) {
          // if (rect.bottom >= 0 && rect.top <= viewHeight)
          if (image.dataset.src && !image.src) {
            image.src = image.dataset.src
            //image.removeAttribute('image-src')
            delete image.dataset.src
          }
        }
      }
    }
    const throttle = (fn, delay) => {
      let timer
      return function () {
        if (!timer) {
          timer = setTimeout(() => {
            fn()
            timer = null
          }, delay)
        }
      }
    }
    window.addEventListener('scroll', throttle(lazyLoad, 500))

    //IntersectionObserver
    const config = {
      rootMargin: '0px',
      threshold: 0,
    }
    let observer = new IntersectionObserver((entries, self) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          let img = entry.target
          let src = img.dataset.src
          if (src) {
            img.src = src
            img.removeAttribute('data-src')
          }
          self.unobserve(entry.target)
        }
      })
    }, config)

    imgs.forEach((image) => observer.observe(image))
  </script>
</body>

</html>